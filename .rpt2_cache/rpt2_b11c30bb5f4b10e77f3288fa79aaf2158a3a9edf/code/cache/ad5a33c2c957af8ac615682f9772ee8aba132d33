{
  "code": "import PopDialog, { PopEffect } from \"./PopDialog\";\r\nimport { Events } from \"../script/Events\";\r\nimport { Paper } from \"../script/Paper\";\r\nimport { CardUI } from \"../script/CardUI\";\r\nimport { CardManager } from \"../script/CardManager\";\r\nexport class GameScene extends Laya.Scene {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.ifinLove = false;\r\n        this.ifinDepress = false;\r\n        this.ifill = false;\r\n    }\r\n    createChildren() {\r\n        super.createChildren();\r\n        this.loadScene(\"GameScene\");\r\n        this.popdialog = new PopDialog(this);\r\n        this.popdialog.loadScene(\"PopDialog\");\r\n        this.events = new Events();\r\n        this.cardmanager = new CardManager();\r\n        this.cardUIs = [];\r\n        for (let i = 0; i < 7; i++) {\r\n            let cardUI = new CardUI(i);\r\n            this.cardUIs.push(cardUI);\r\n        }\r\n    }\r\n    onAwake() {\r\n        this.btn_next.on(Laya.Event.CLICK, this, this.nextTurn);\r\n        this.cardUIs[0].button = this.cardBtn1;\r\n        this.cardUIs[1].button = this.cardBtn2;\r\n        this.cardUIs[2].button = this.cardBtn3;\r\n        this.cardUIs[3].button = this.cardBtn4;\r\n        this.cardUIs[4].button = this.cardBtn5;\r\n        this.cardUIs[5].button = this.cardBtn6;\r\n        this.cardUIs[6].button = this.cardBtn7;\r\n        for (let i = 0; i < 7; i++) {\r\n            this.cardUIs[i].init();\r\n        }\r\n        this.cardTxt.on(Laya.Event.CLICK, this, this.onClickCard);\r\n        this.btnDo.on(Laya.Event.CLICK, this, () => { this.onDoCard(CardUI.seletedIndex); });\r\n        this.btnDiscard.on(Laya.Event.CLICK, this, () => { this.onDiscard(CardUI.seletedIndex); });\r\n        this.on(Laya.Event.CLICK, this, this.onClick);\r\n    }\r\n    onClickCard() {\r\n        CardUI.cardClicked = true;\r\n    }\r\n    onClick() {\r\n        if (!CardUI.cardClicked) {\r\n            CardUI.seletedIndex = -1;\r\n        }\r\n        if (CardUI.seletedIndex == -1) {\r\n            this.cardinfo.visible = false;\r\n        }\r\n        else {\r\n            this.cardTxt.text = this.cardUIs[CardUI.seletedIndex].getcardinfo();\r\n            this.cardinfo.visible = true;\r\n        }\r\n        for (let i = 0; i < this.cardUIs.length; i++) {\r\n            this.cardUIs[i].updateUI();\r\n        }\r\n        CardUI.cardClicked = false;\r\n    }\r\n    onDestroyCard(index) {\r\n        Laya.SoundManager.playSound(\"sound/destroy.wav\");\r\n        for (let i = index; i < this.cardUIs.length - 1; i++) {\r\n            this.cardUIs[i].card = this.cardUIs[i + 1].card;\r\n        }\r\n        this.cardUIs[this.cardUIs.length - 1].card = null;\r\n        CardUI.seletedIndex = -1;\r\n        this.updateUI();\r\n    }\r\n    onDoCard(index) {\r\n        console.log(index);\r\n        let effect = this.cardUIs[index].card.effect;\r\n        let popevent = this.cardUIs[index].card.event;\r\n        if (this.money + effect.cMoney < 0) {\r\n            this.alert(this.events.getNoMoney());\r\n            return;\r\n        }\r\n        if (this.enegy + effect.cEnergy < 0) {\r\n            this.alert(this.events.getNoEnergy());\r\n            return;\r\n        }\r\n        this.settleEffect(effect);\r\n        if (popevent != null) {\r\n            this.alert([popevent]);\r\n        }\r\n        this.onDestroyCard(index);\r\n    }\r\n    onDiscard(index) {\r\n        let card = this.cardUIs[index].card;\r\n        if (card.se != null) {\r\n            this.settleEffect(card.se);\r\n        }\r\n        this.onDestroyCard(index);\r\n    }\r\n    init(ifChinese) {\r\n        GameScene.ifChinses = ifChinese;\r\n        this.currentPaper = new Paper(0, 0, 0);\r\n        this.bestPaper = new Paper(0, 0, 0);\r\n        this.cardinfo.visible = false;\r\n        this.grade = 1;\r\n        this.season = 1;\r\n        this.money = 0;\r\n        this.enegy = 7;\r\n        this.score = 0;\r\n        this.paper = 0;\r\n        this.finalpaperpercent = 0;\r\n        this.paperpercent = 0;\r\n        this.ifPass = false;\r\n        this.p_ifgoal1.visible = false;\r\n        this.p_ifgoal2.visible = false;\r\n        this.p_ifgoal3.visible = false;\r\n        this.p_ifgoal4.visible = false;\r\n        this.health = 100;\r\n        this.conf = 100;\r\n        this.soc = 60;\r\n        this.love = 60;\r\n        this.mot = 60;\r\n        this.adv = 60;\r\n        this.ifinDepress = false;\r\n        this.ifinLove = false;\r\n        this.cardmanager.genCardPool(this.score, this.ifinLove, this.ifinDepress, this.health, this.conf, this.soc, this.love, this.mot, this.adv);\r\n        for (let i = 0; i < this.cardUIs.lengthl; i++) {\r\n            if (this.cardUIs[i].card == null) {\r\n                this.cardUIs[i].card = this.cardmanager.getCard();\r\n            }\r\n        }\r\n        this.cardUIs[0].card = this.cardmanager.getCardById(0);\r\n        this.cardUIs[1].card = this.cardmanager.getCardById(1);\r\n        this.cardUIs[2].card = this.cardmanager.getCardById(2);\r\n        this.cardUIs[3].card = this.cardmanager.getCardById(3);\r\n        this.cardUIs[4].card = this.cardmanager.getCard();\r\n        this.cardUIs[5].card = this.cardmanager.getCard();\r\n        this.cardUIs[6].card = this.cardmanager.getCard();\r\n        if (ifChinese) {\r\n            this.s_bg.loadImage(\"test/bg-cn.png\");\r\n            this.c_grade.skin = \"comp/grade_cn.png\";\r\n            this.c_season.skin = \"comp/season_cn.png\";\r\n            this.btn_next.label = \"下一回合\";\r\n            this.btnDo.label = \"执行\";\r\n            this.btnDiscard.label = \"弃牌\";\r\n            this.cardTxt.fontSize = 24;\r\n        }\r\n        else {\r\n            this.s_bg.loadImage(\"test/bg-en.png\");\r\n            this.c_grade.skin = \"comp/grade_en.png\";\r\n            this.c_season.skin = \"comp/season_en.png\";\r\n            this.btn_next.label = \"Next turn\";\r\n            this.btnDo.label = \"Do it\";\r\n            this.btnDiscard.label = \"Discard\";\r\n            this.cardTxt.fontSize = 18;\r\n        }\r\n        this.updateUI();\r\n        let events = this.events.getAllowance().concat(this.events.getInitEvent());\r\n        this.alert(events);\r\n    }\r\n    nextTurn() {\r\n        for (let i = this.cardUIs.length - 1; i >= 0; i--) {\r\n            if (this.cardUIs[i].card != null && this.cardUIs[i].card.lim) {\r\n                this.onDiscard(i);\r\n            }\r\n        }\r\n        this.updateUI();\r\n        if (this.cardUIs[4].card != null) {\r\n            this.alert(this.events.getTeachInfo1());\r\n            return;\r\n        }\r\n        if (this.grade == 1 && this.season == 1) {\r\n            this.alert(this.events.getTeachInfo1());\r\n        }\r\n        this.season += 1;\r\n        if (this.season == 5) {\r\n            this.grade++;\r\n            this.season = 1;\r\n        }\r\n        if (this.grade == 9) {\r\n            this.endGame();\r\n        }\r\n        this.updateUI();\r\n        let events = this.events.checkEvents(this.grade, this.season);\r\n        if (this.grade < 6 && this.season == 1) {\r\n            events = events.concat(this.events.getAllowance());\r\n        }\r\n        if (this.health < 40) {\r\n            if (!this.ifill) {\r\n                this.ifill = true;\r\n                events = events.concat(this.events.getill());\r\n            }\r\n        }\r\n        else {\r\n            if (this.ifill) {\r\n                this.ifill = false;\r\n                events = events.concat(this.events.getcure());\r\n            }\r\n        }\r\n        if (this.conf < 40) {\r\n            if (!this.ifinDepress) {\r\n                this.ifinDepress = true;\r\n                events = events.concat(this.events.getDepress());\r\n            }\r\n        }\r\n        else {\r\n            if (this.ifinDepress) {\r\n                this.ifinDepress = false;\r\n                events = events.concat(this.events.getRemovedDepress());\r\n            }\r\n        }\r\n        if (events.length > 0) {\r\n            this.alert(events);\r\n        }\r\n        this.enegy = 7;\r\n        Laya.SoundManager.playSound(\"sound/hit.wav\");\r\n        this.getEffectforEachTurn();\r\n        this.cardmanager.genCardPool(this.score, this.ifinLove, this.ifinDepress, this.health, this.conf, this.soc, this.love, this.mot, this.adv);\r\n        for (let i = 0; i < this.cardUIs.length; i++) {\r\n            console.log(this.cardUIs[i].card);\r\n            if (this.cardUIs[i].card == null) {\r\n                this.cardUIs[i].card = this.cardmanager.getCard();\r\n            }\r\n        }\r\n        this.updateUI();\r\n    }\r\n    updateUI() {\r\n        this.l_money.text = this.money.toString();\r\n        this.c_grade.value = this.grade.toString();\r\n        this.c_season.value = this.season.toString();\r\n        this.l_score.text = this.score.toString();\r\n        this.l_paper.text = this.paper.toString();\r\n        this.l_fpp.text = this.finalpaperpercent.toString();\r\n        this.l_enegy.text = this.enegy.toString();\r\n        this.p_paperpercent.value = this.paperpercent / 100;\r\n        this.p_health.value = this.health / 100;\r\n        this.p_conf.value = this.conf / 100;\r\n        this.p_soc.value = this.soc / 100;\r\n        this.p_love.value = this.love / 100;\r\n        this.p_mot.value = this.mot / 100;\r\n        this.p_adv.value = this.adv / 100;\r\n        if (this.cardUIs != null) {\r\n            for (let i = 0; i < this.cardUIs.length; i++) {\r\n                this.cardUIs[i].updateUI();\r\n            }\r\n        }\r\n        if (this.checkWin()) {\r\n            this.endGame();\r\n        }\r\n        this.updateStatusShow();\r\n    }\r\n    alert(events) {\r\n        this.popdialog.init(events);\r\n        this.popdialog.open();\r\n    }\r\n    getInLoveProb() {\r\n        let num = (this.health + this.conf - 100) / 2;\r\n        return num > 0 ? num : 0;\r\n    }\r\n    settleEffect(popeffect) {\r\n        if (popeffect == null) {\r\n            return;\r\n        }\r\n        this.money += popeffect.cMoney;\r\n        this.currentPaper.process += popeffect.cProcess;\r\n        this.currentPaper.value += popeffect.cValue;\r\n        this.enegy += popeffect.cEnergy;\r\n        this.health += popeffect.cHealth;\r\n        this.conf += popeffect.cConf;\r\n        this.soc += popeffect.cSoc;\r\n        this.love += popeffect.cLove;\r\n        this.mot += popeffect.cMot;\r\n        this.adv += popeffect.cAdv;\r\n        this.paperpercent = this.currentPaper.process;\r\n        this.health = (this.health < 0 ? 0 : (this.health > 100 ? 100 : this.health));\r\n        this.conf = (this.conf < 0 ? 0 : (this.conf > 100 ? 100 : this.conf));\r\n        this.soc = (this.soc < 0 ? 0 : (this.soc > 100 ? 100 : this.soc));\r\n        this.love = (this.love < 0 ? 0 : (this.love > 100 ? 100 : this.love));\r\n        this.mot = (this.mot < 0 ? 0 : (this.mot > 100 ? 100 : this.mot));\r\n        this.adv = (this.adv < 0 ? 0 : (this.adv > 100 ? 100 : this.adv));\r\n        this.paperpercent = (this.paperpercent < 0 ? 0 : (this.paperpercent > 100 ? 100 : this.paperpercent));\r\n        if (popeffect.specialNote == 1) {\r\n            let rnd = Math.random() * 100;\r\n            let pro = this.getInLoveProb();\r\n            if (rnd < pro) {\r\n                this.alert(this.events.getSuccessInLove());\r\n                this.ifinLove = true;\r\n            }\r\n            else {\r\n                this.alert(this.events.getFailInLove());\r\n            }\r\n        }\r\n        if (popeffect.specialNote == 2) {\r\n            this.score += 1;\r\n            this.alert(this.events.getOneScore());\r\n        }\r\n        if (popeffect.specialNote == 3) {\r\n            this.alert(this.events.getRejectAdv());\r\n        }\r\n        if (popeffect.specialNote == 4) {\r\n            this.alert(this.events.getInternship());\r\n        }\r\n        if (popeffect.specialNote == 5) {\r\n            if (Math.random() <= 0.2) {\r\n                this.ifinLove = false;\r\n                this.alert(this.events.getBreakUp());\r\n            }\r\n        }\r\n        this.updateUI();\r\n    }\r\n    checkWin() {\r\n        if (this.score >= 6) {\r\n            this.p_ifgoal1.visible = true;\r\n        }\r\n        if (this.paper >= 2) {\r\n            this.p_ifgoal2.visible = true;\r\n        }\r\n        if (this.finalpaperpercent >= 100) {\r\n            this.p_ifgoal3.visible = true;\r\n        }\r\n        if (this.ifPass) {\r\n            this.p_ifgoal4.visible = this.ifPass;\r\n        }\r\n        if (this.p_ifgoal1.visible && this.p_ifgoal2.visible && this.p_ifgoal3.visible && this.p_ifgoal4.visible) {\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    endGame() {\r\n        Laya.stage.removeChild(this);\r\n    }\r\n    genEffectforStatus() {\r\n        let effect = new PopEffect(0, 0, 0, 0, 0, 0, -10, -10, 0, 0);\r\n        if (this.ifinLove) {\r\n            effect.cSoc += 15;\r\n            effect.cLove += 15;\r\n            effect.cEnergy -= 1;\r\n        }\r\n        if (this.ifinDepress) {\r\n            effect.cHealth -= 10;\r\n            effect.cConf -= 10;\r\n            effect.cMot -= 10;\r\n            effect.cAdv -= 10;\r\n        }\r\n        if (this.ifill) {\r\n            effect.cEnergy -= 3;\r\n        }\r\n        return effect;\r\n    }\r\n    getEffectforEachTurn() {\r\n        let effect = this.genEffectforStatus();\r\n        this.settleEffect(effect);\r\n    }\r\n    updateStatusShow() {\r\n        this.l_status.text = \"\";\r\n        if (this.ifinLove) {\r\n            this.l_status.text += GameScene.ifChinses ? \"恋爱中\" : \"In love\";\r\n        }\r\n        if (this.ifinDepress) {\r\n            this.l_status.text += GameScene.ifChinses ? \"抑郁中\" : \"In depression\";\r\n        }\r\n        if (this.ifill) {\r\n            this.l_status.text += GameScene.ifChinses ? \"生病\" : \"Get ill\";\r\n        }\r\n        if (this.l_status.text.length == 0) {\r\n            this.l_status.text = \"普通\";\r\n        }\r\n        let effect = this.genEffectforStatus();\r\n        if (GameScene.ifChinses) {\r\n            this.l_cstatus.text = \"该状态每回合的\" + Events.genEffectInfo(GameScene.ifChinses, effect);\r\n        }\r\n        else {\r\n            this.l_cstatus.text = \"status' \" + Events.genEffectInfo(GameScene.ifChinses, effect) + \" for each turn.\";\r\n        }\r\n    }\r\n}\r\n",
  "references": [
    "C:/Users/huang/Documents/myLaya/ld46_KeepDoctorAlive/src/scene/PopDialog.ts",
    "C:/Users/huang/Documents/myLaya/ld46_KeepDoctorAlive/src/script/Events.ts",
    "C:/Users/huang/Documents/myLaya/ld46_KeepDoctorAlive/src/script/Paper.ts",
    "C:/Users/huang/Documents/myLaya/ld46_KeepDoctorAlive/src/script/CardUI.ts",
    "C:/Users/huang/Documents/myLaya/ld46_KeepDoctorAlive/src/script/CardManager.ts"
  ]
}
